name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    name: Build for Production
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Run tests
      run: dotnet test --configuration Release --no-restore
    
    - name: Build Blazor WASM
      run: |
        dotnet publish Slingcessories/Slingcessories.csproj \
          --configuration Release \
          --output ./blazor-publish
    
    - name: Build API
      run: |
        dotnet publish Slingcessories.Service/Slingcessories.Service.csproj \
          --configuration Release \
          --output ./api-publish
    
    - name: Upload Blazor artifacts
      uses: actions/upload-artifact@v4
      with:
        name: blazor-production
        path: ./blazor-publish/wwwroot
    
    - name: Upload API artifacts
      uses: actions/upload-artifact@v4
      with:
        name: api-production
        path: ./api-publish

  deploy-blazor:
    name: Deploy Blazor App
    runs-on: ubuntu-latest
    needs: build
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://your-app-url.com
    
    steps:
    - name: Download Blazor artifacts
      uses: actions/download-artifact@v4
      with:
        name: blazor-production
        path: ./blazor-app
    
    - name: Deploy to Azure Static Web Apps (or your hosting)
      run: |
        echo "?? Deploy Blazor app here"
        echo "Artifact ready at: ./blazor-app"
        # Add your deployment commands here
        # Example for Azure Static Web Apps:
        # az staticwebapp upload --resource-group <RG> --name <APP_NAME> --app-location ./blazor-app
    
    - name: Create deployment summary
      run: |
        echo "## ?? Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy-api:
    name: Deploy API Service
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://your-api-url.com
    
    steps:
    - name: Download API artifacts
      uses: actions/download-artifact@v4
      with:
        name: api-production
        path: ./api
    
    - name: Deploy API (Example: Azure App Service)
      run: |
        echo "?? Deploy API here"
        echo "Artifact ready at: ./api"
        # Add your API deployment commands here
        # Example for Azure App Service:
        # az webapp deployment source config-zip --resource-group <RG> --name <APP_NAME> --src api.zip
