@page "/categories"
@using System.Net.Http.Json
@using Slingcessories.Services
@inject HttpClient Http
@inject UserStateService UserStateService
@implements IDisposable

<PageTitle>Categories</PageTitle>

<div class="mb-2">
    <NavLink href="/settings" class="btn btn-link p-0 text-decoration-none" title="Back to Settings">
        &larr; Back to Settings
    </NavLink>
</div>

<h1>Categories & Subcategories</h1>

<div class="mb-3 d-flex gap-2">
    <button class="btn btn-success btn-sm" @onclick="ShowCreateModal">+ New Category</button>
    <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleExpandAll">
        <span class="@(allExpanded ? "bi bi-chevron-up" : "bi bi-chevron-down") me-1"></span>
        @(allExpanded ? "Collapse All" : "Expand All")
    </button>
    <button class="btn btn-outline-primary btn-sm"
            @onclick="Reload"
            disabled="@saving || isLoading">Refresh</button>
</div>

@if (errorMessage is not null)
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (isLoading)
{
    <p>Loading categories...</p>
}
else
{
    @if (categories.Count == 0)
    {
        <p>No categories found.</p>
    }
    else
    {
        <ul class="list-group mb-3">
            @foreach (var c in categories)
            {
                <li class="list-group-item">
                    @if (editingCategoryId == c.Id)
                    {
                        <EditForm Model="editCategoryModel" OnValidSubmit="SaveCategoryEditAsync">
                            <DataAnnotationsValidator />
                            <div class="d-flex align-items-center gap-2">
                                <InputText class="form-control form-control-sm w-auto"
                                           @bind-Value="editCategoryModel.Name" />
                                <button type="submit"
                                        class="btn btn-sm btn-primary"
                                        disabled="@saving">
                                    @(saving ? "Saving..." : "Save")
                                </button>
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        @onclick="CancelCategoryEdit"
                                        disabled="@saving">Cancel</button>
                            </div>
                            <ValidationMessage For="() => editCategoryModel.Name" />
                        </EditForm>
                    }
                    else
                    {
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-link p-0 text-decoration-none" 
                                        @onclick="() => ToggleCategory(c.Id)"
                                        style="min-width: 24px;">
                                    <span class="@(expandedCategories.Contains(c.Id) ? "bi bi-chevron-down" : "bi bi-chevron-right")"></span>
                                </button>
                                <strong>@c.Name</strong>
                                <span class="badge bg-secondary">@GetSubcategoryCount(c.Id)</span>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" @onclick="() => ShowAddSubcategoryModal(c.Id)">
                                    <span class="bi bi-plus-circle me-1"></span>Add Subcategory
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="() => BeginCategoryEdit(c)">Edit</button>
                                @if (confirmDeleteCategoryId == c.Id)
                                {
                                    <button class="btn btn-danger" disabled="@saving" @onclick="() => DeleteCategoryAsync(c.Id)">Confirm</button>
                                    <button class="btn btn-outline-secondary" disabled="@saving" @onclick="() => confirmDeleteCategoryId = null">Cancel</button>
                                }
                                else
                                {
                                    <button class="btn btn-outline-danger" disabled="@saving" @onclick="() => confirmDeleteCategoryId = c.Id">Delete</button>
                                }
                            </div>
                        </div>

                        @* Subcategories for this category *@
                        @if (expandedCategories.Contains(c.Id))
                        {
                            var categorySubcategories = subcategories.Where(s => s.CategoryId == c.Id).ToList();
                            @if (categorySubcategories.Any())
                            {
                                <ul class="list-group mt-2 ms-4">
                                    @foreach (var sc in categorySubcategories)
                                    {
                                        <li class="list-group-item list-group-item-light">
                                            @if (editingSubcategoryId == sc.Id)
                                            {
                                                <EditForm Model="editSubcategoryModel" OnValidSubmit="SaveSubcategoryEditAsync">
                                                    <DataAnnotationsValidator />
                                                    <div class="d-flex align-items-center gap-2">
                                                        <InputText class="form-control form-control-sm w-auto"
                                                                   @bind-Value="editSubcategoryModel.Name" />
                                                        <button type="submit"
                                                                class="btn btn-sm btn-primary"
                                                                disabled="@saving">
                                                            @(saving ? "Saving..." : "Save")
                                                        </button>
                                                        <button type="button"
                                                                class="btn btn-sm btn-secondary"
                                                                @onclick="CancelSubcategoryEdit"
                                                                disabled="@saving">Cancel</button>
                                                    </div>
                                                    <ValidationMessage For="() => editSubcategoryModel.Name" />
                                                </EditForm>
                                            }
                                            else
                                            {
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span>@sc.Name</span>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-secondary btn-sm" @onclick="() => BeginSubcategoryEdit(sc)">Edit</button>
                                                        @if (confirmDeleteSubcategoryId == sc.Id)
                                                        {
                                                            <button class="btn btn-danger btn-sm" disabled="@saving" @onclick="() => DeleteSubcategoryAsync(sc.Id)">Confirm</button>
                                                            <button class="btn btn-outline-secondary btn-sm" disabled="@saving" @onclick="() => confirmDeleteSubcategoryId = null">Cancel</button>
                                                        }
                                                        else
                                                        {
                                                            <button class="btn btn-outline-danger btn-sm" disabled="@saving" @onclick="() => confirmDeleteSubcategoryId = sc.Id">Delete</button>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted ms-4 mt-2 mb-0 small">No subcategories yet. Click "Add Subcategory" to create one.</p>
                            }
                        }
                    }
                </li>
            }
        </ul>
    }
}

@* Create Category Modal *@
@if (showCreateCategoryModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Category</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CancelCreateCategory"></button>
                </div>
                <EditForm Model="createCategoryModel" OnValidSubmit="CreateCategoryAsync">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="mb-2">
                            <label class="form-label">Name</label>
                            <InputText class="form-control form-control-sm"
                                       @bind-Value="createCategoryModel.Name"
                                       @onkeydown="HandleCreateCategoryKeyDown" />
                            <ValidationMessage For="() => createCategoryModel.Name" />
                        </div>
                        @if (createError is not null)
                        {
                            <div class="alert alert-danger py-1 px-2 mb-2">@createError</div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="submit"
                                class="btn btn-primary btn-sm"
                                disabled="@savingCreate">
                            @(savingCreate ? "Saving..." : "OK")
                        </button>
                        <button type="button"
                                class="btn btn-secondary btn-sm"
                                @onclick="CancelCreateCategory"
                                disabled="@savingCreate">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@* Create Subcategory Modal *@
@if (showCreateSubcategoryModal && selectedCategoryId.HasValue)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Subcategory</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CancelCreateSubcategory"></button>
                </div>
                <EditForm Model="createSubcategoryModel" OnValidSubmit="CreateSubcategoryAsync">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="mb-2">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control form-control-sm" 
                                   value="@GetCategoryName(selectedCategoryId.Value)" 
                                   disabled />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Name</label>
                            <InputText class="form-control form-control-sm"
                                       @bind-Value="createSubcategoryModel.Name"
                                       @onkeydown="HandleCreateSubcategoryKeyDown" />
                            <ValidationMessage For="() => createSubcategoryModel.Name" />
                        </div>
                        @if (createSubcategoryError is not null)
                        {
                            <div class="alert alert-danger py-1 px-2 mb-2">@createSubcategoryError</div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="submit"
                                class="btn btn-primary btn-sm"
                                disabled="@savingCreateSubcategory">
                            @(savingCreateSubcategory ? "Saving..." : "OK")
                        </button>
                        <button type="button"
                                class="btn btn-secondary btn-sm"
                                @onclick="CancelCreateSubcategory"
                                disabled="@savingCreateSubcategory">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    // Data
    private List<CategoryDto> categories = [];
    private List<SubcategoryDto> subcategories = [];
    private HashSet<int> expandedCategories = new();
    private bool allExpanded = false;
    
    // State
    private bool isLoading = true;
    private string? errorMessage;
    private bool saving;

    // Category editing
    private int? editingCategoryId;
    private CategoryEditModel? editCategoryModel;
    private int? confirmDeleteCategoryId;

    // Subcategory editing
    private int? editingSubcategoryId;
    private SubcategoryEditModel? editSubcategoryModel;
    private int? confirmDeleteSubcategoryId;

    // Create category modal
    private bool showCreateCategoryModal;
    private CreateCategoryModel createCategoryModel = new();
    private bool savingCreate;
    private string? createError;

    // Create subcategory modal
    private bool showCreateSubcategoryModal;
    private int? selectedCategoryId;
    private CreateSubcategoryModel createSubcategoryModel = new();
    private bool savingCreateSubcategory;
    private string? createSubcategoryError;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to user change events
        UserStateService.OnUserChanged += HandleUserChanged;
        await LoadAsync();
    }

    private void HandleUserChanged()
    {
        // Reload data when user changes
        InvokeAsync(async () => await LoadAsync());
    }

    private async Task LoadAsync()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            // Build URLs with userId parameter if a user is selected
            var categoriesUrl = "api/categories";
            var subcategoriesUrl = "api/subcategories";
            
            if (!string.IsNullOrEmpty(UserStateService.CurrentUserId))
            {
                categoriesUrl += $"?userId={Uri.EscapeDataString(UserStateService.CurrentUserId)}";
                subcategoriesUrl += $"?userId={Uri.EscapeDataString(UserStateService.CurrentUserId)}";
            }

            var catResult = await Http.GetFromJsonAsync<List<CategoryDto>>(categoriesUrl);
            categories = catResult ?? [];

            var subResult = await Http.GetFromJsonAsync<List<SubcategoryDto>>(subcategoriesUrl);
            subcategories = subResult ?? [];
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Reload()
    {
        if (saving || savingCreate || savingCreateSubcategory) return;
        categories.Clear();
        subcategories.Clear();
        await LoadAsync();
    }

    private void ToggleExpandAll()
    {
        if (allExpanded)
        {
            // Collapse all
            expandedCategories.Clear();
            allExpanded = false;
        }
        else
        {
            // Expand all
            expandedCategories.Clear();
            foreach (var category in categories)
            {
                expandedCategories.Add(category.Id);
            }
            allExpanded = true;
        }
    }

    /* Helpers */
    private void ToggleCategory(int categoryId)
    {
        if (expandedCategories.Contains(categoryId))
            expandedCategories.Remove(categoryId);
        else
            expandedCategories.Add(categoryId);
        
        UpdateAllExpandedState();
    }

    private void UpdateAllExpandedState()
    {
        allExpanded = categories.Count > 0 && expandedCategories.Count == categories.Count;
    }

    private int GetSubcategoryCount(int categoryId) 
        => subcategories.Count(s => s.CategoryId == categoryId);

    private string GetCategoryName(int categoryId)
        => categories.FirstOrDefault(c => c.Id == categoryId)?.Name ?? "Unknown";

    /* Category Edit */
    private void BeginCategoryEdit(CategoryDto c)
    {
        if (saving || savingCreate || savingCreateSubcategory) return;
        editingCategoryId = c.Id;
        editCategoryModel = new CategoryEditModel { Id = c.Id, Name = c.Name };
        confirmDeleteCategoryId = null;
    }

    private void CancelCategoryEdit()
    {
        if (saving) return;
        editingCategoryId = null;
        editCategoryModel = null;
    }

    private async Task SaveCategoryEditAsync()
    {
        if (editCategoryModel is null || editingCategoryId != editCategoryModel.Id) return;
        saving = true;
        errorMessage = null;

        try
        {
            var dto = new CategoryDto(editCategoryModel.Id, editCategoryModel.Name.Trim());
            var response = await Http.PutAsJsonAsync($"api/categories/{dto.Id}", dto);

            if (response.IsSuccessStatusCode)
            {
                var index = categories.FindIndex(c => c.Id == dto.Id);
                if (index >= 0) categories[index] = dto;
                CancelCategoryEdit();
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                errorMessage = $"Update failed ({(int)response.StatusCode} {response.StatusCode}): {body}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Update error: {ex.Message}";
        }
        finally
        {
            saving = false;
        }
    }

    /* Category Delete */
    private async Task DeleteCategoryAsync(int id)
    {
        saving = true;
        errorMessage = null;
        try
        {
            var response = await Http.DeleteAsync($"api/categories/{id}");
            if (response.IsSuccessStatusCode)
            {
                categories.RemoveAll(c => c.Id == id);
                subcategories.RemoveAll(s => s.CategoryId == id);
                expandedCategories.Remove(id);
                if (editingCategoryId == id) CancelCategoryEdit();
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                errorMessage = $"Delete failed ({(int)response.StatusCode} {response.StatusCode}): {body}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Delete error: {ex.Message}";
        }
        finally
        {
            saving = false;
            confirmDeleteCategoryId = null;
        }
    }

    /* Category Create */
    private void ShowCreateModal()
    {
        createError = null;
        createCategoryModel = new();
        showCreateCategoryModal = true;
    }

    private void CancelCreateCategory()
    {
        if (savingCreate) return;
        showCreateCategoryModal = false;
        createCategoryModel = new();
        createError = null;
    }

    private async Task CreateCategoryAsync()
    {
        bool success = false;
        savingCreate = true;
        createError = null;
        try
        {
            // Ensure user is selected
            if (string.IsNullOrEmpty(UserStateService.CurrentUserId))
            {
                createError = "Please select a user before creating categories.";
                return;
            }

            var trimmed = createCategoryModel.Name.Trim();
            var payload = new CreateCategoryPayload 
            { 
                Name = trimmed,
                UserId = UserStateService.CurrentUserId
            };
            var response = await Http.PostAsJsonAsync("api/categories", payload);

            if (response.IsSuccessStatusCode)
            {
                var created = await response.Content.ReadFromJsonAsync<CategoryDto>();
                if (created is not null)
                {
                    categories.Add(created);
                    categories = categories.OrderBy(c => c.Name).ToList();
                }
                success = true;
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                createError = $"Create failed ({(int)response.StatusCode} {response.StatusCode}): {body}";
            }
        }
        catch (Exception ex)
        {
            createError = $"Create error: {ex.Message}";
        }
        finally
        {
            savingCreate = false;
            if (success) CancelCreateCategory();
        }
    }

    private void HandleCreateCategoryKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape") CancelCreateCategory();
    }

    /* Subcategory Edit */
    private void BeginSubcategoryEdit(SubcategoryDto sc)
    {
        if (saving || savingCreate || savingCreateSubcategory) return;
        editingSubcategoryId = sc.Id;
        editSubcategoryModel = new SubcategoryEditModel { Id = sc.Id, Name = sc.Name, CategoryId = sc.CategoryId };
        confirmDeleteSubcategoryId = null;
    }

    private void CancelSubcategoryEdit()
    {
        if (saving) return;
        editingSubcategoryId = null;
        editSubcategoryModel = null;
    }

    private async Task SaveSubcategoryEditAsync()
    {
        if (editSubcategoryModel is null || editingSubcategoryId != editSubcategoryModel.Id) return;
        saving = true;
        errorMessage = null;

        try
        {
            var dto = new SubcategoryDto(editSubcategoryModel.Id, editSubcategoryModel.Name.Trim(), editSubcategoryModel.CategoryId);
            var response = await Http.PutAsJsonAsync($"api/subcategories/{dto.Id}", dto);

            if (response.IsSuccessStatusCode)
            {
                var index = subcategories.FindIndex(s => s.Id == dto.Id);
                if (index >= 0) subcategories[index] = dto;
                CancelSubcategoryEdit();
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                errorMessage = $"Update failed ({(int)response.StatusCode} {response.StatusCode}): {body}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Update error: {ex.Message}";
        }
        finally
        {
            saving = false;
        }
    }

    /* Subcategory Delete */
    private async Task DeleteSubcategoryAsync(int id)
    {
        saving = true;
        errorMessage = null;
        try
        {
            var response = await Http.DeleteAsync($"api/subcategories/{id}");
            if (response.IsSuccessStatusCode)
            {
                subcategories.RemoveAll(s => s.Id == id);
                if (editingSubcategoryId == id) CancelSubcategoryEdit();
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                errorMessage = $"Delete failed ({(int)response.StatusCode} {response.StatusCode}): {body}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Delete error: {ex.Message}";
        }
        finally
        {
            saving = false;
            confirmDeleteSubcategoryId = null;
        }
    }

    /* Subcategory Create */
    private void ShowAddSubcategoryModal(int categoryId)
    {
        if (saving || savingCreate) return;
        selectedCategoryId = categoryId;
        createSubcategoryError = null;
        createSubcategoryModel = new();
        showCreateSubcategoryModal = true;
        
        // Expand the category to show the new subcategory after creation
        if (!expandedCategories.Contains(categoryId))
            expandedCategories.Add(categoryId);
    }

    private void CancelCreateSubcategory()
    {
        if (savingCreateSubcategory) return;
        showCreateSubcategoryModal = false;
        selectedCategoryId = null;
        createSubcategoryModel = new();
        createSubcategoryError = null;
    }

    private async Task CreateSubcategoryAsync()
    {
        if (!selectedCategoryId.HasValue) return;
        
        bool success = false;
        savingCreateSubcategory = true;
        createSubcategoryError = null;
        try
        {
            // Ensure user is selected
            if (string.IsNullOrEmpty(UserStateService.CurrentUserId))
            {
                createSubcategoryError = "Please select a user before creating subcategories.";
                return;
            }

            var trimmed = createSubcategoryModel.Name.Trim();
            var payload = new CreateSubcategoryPayload 
            { 
                Name = trimmed, 
                CategoryId = selectedCategoryId.Value,
                UserId = UserStateService.CurrentUserId
            };
            var response = await Http.PostAsJsonAsync("api/subcategories", payload);

            if (response.IsSuccessStatusCode)
            {
                var created = await response.Content.ReadFromJsonAsync<SubcategoryDto>();
                if (created is not null)
                {
                    subcategories.Add(created);
                    subcategories = subcategories.OrderBy(s => s.Name).ToList();
                }
                success = true;
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                createSubcategoryError = $"Create failed ({(int)response.StatusCode} {response.StatusCode}): {body}";
            }
        }
        catch (Exception ex)
        {
            createSubcategoryError = $"Create error: {ex.Message}";
        }
        finally
        {
            savingCreateSubcategory = false;
            if (success) CancelCreateSubcategory();
        }
    }

    private void HandleCreateSubcategoryKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape") CancelCreateSubcategory();
    }

    /* Records / Models */
    private sealed record CategoryDto(int Id, string Name);
    private sealed record SubcategoryDto(int Id, string Name, int CategoryId);

    private sealed class CategoryEditModel
    {
        public int Id { get; set; }

        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.StringLength(100)]
        public string Name { get; set; } = string.Empty;
    }

    private sealed class SubcategoryEditModel
    {
        public int Id { get; set; }

        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.StringLength(100)]
        public string Name { get; set; } = string.Empty;

        public int CategoryId { get; set; }
    }

    private sealed class CreateCategoryModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.StringLength(100)]
        public string Name { get; set; } = string.Empty;
    }

    private sealed class CreateSubcategoryModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.StringLength(100)]
        public string Name { get; set; } = string.Empty;
    }

    private sealed class CreateCategoryPayload
    {
        public string Name { get; set; } = string.Empty;
        public string UserId { get; set; } = string.Empty;
    }

    private sealed class CreateSubcategoryPayload
    {
        public string Name { get; set; } = string.Empty;
        public int CategoryId { get; set; }
        public string UserId { get; set; } = string.Empty;
    }

    public void Dispose()
    {
        UserStateService.OnUserChanged -= HandleUserChanged;
    }
}